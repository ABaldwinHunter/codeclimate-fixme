#!/usr/bin/env node

// Dependencies
var glob = require("glob");
var exec = require('child_process').exec;

// Strings to scan for in source
var fixmeStrings = "'FIXME|TODO|HACK|BUG'";

// Prints properly structured Issue data to STDOUT according to
// Code Climate Engine specification.
var printIssue = function(fileName, lineNum){
  var issue = {
    "type": "issue",
    "check_name": "FIXME found",
    "description": "Code comment found that needs your attention.",
    "categories": ["Bug Risk"],
    "location":{
      "path": fileName,
      "lines": {
        "begin": lineNum,
        "end": lineNum 
      }
    }
  };

  // Issues must be followed by a null byte
  var issueString = JSON.stringify(issue)+"\0";
  console.log(issueString);
}

var findFixmes = function(file){
  var grepString = "grep -inH -E " + fixmeStrings + " " + file;

  exec(grepString, function(error, stdout, stderr) {
    var lines = stdout.split("\n");
    lines.forEach(function(line, index, array){
      if(index < (array.length-1)){
        
        var cols = line.split(":");
        var fileName = cols[0].split("/code/")[1];
        var lineNum = cols[1];
        
        printIssue(fileName, lineNum);
      }
    })
  })
}

var fileWalk = function(excludePaths){
  var analysisFiles = [];
  var allFiles = glob.sync("/code/**/**", {});

  allFiles.forEach(function(file, i, a){
    if(excludePaths.indexOf(file.split("/code/")[1]) < 0) {
      analysisFiles.push(file);
    }
  });
    
  return analysisFiles;
}


var runEngine = function(){
  var config = JSON.parse(process.env.ENGINE_CONFIG);

  var analysisFiles = fileWalk(config.exclude_paths);

  analysisFiles.forEach(function(f, i, a){
    findFixmes(f);
  });
}

runEngine();
